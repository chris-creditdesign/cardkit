"use strict";angular.module("cardkitApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","colorpicker.module","draganddrop","colorpicker.module","ui.router"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("index",{url:"/",controller:"MainCtrl",templateUrl:"views/main.html",resolve:{themeConfig:["themeConfigProvider",function(a){return a}]}})}]);var fillColours={Black:"#000000",White:"#ffffff","News Red":"#c50a26","Dark red":"#8b0d16","Light red":"#ea5153","Dark blue":"#5a527e","Light blue":"#8695c5",Turquoise:"#75c6c5","Dark green":"#3a4f3a","Mid green":"#3f8688","Light green":"#8fc297",Brown:"#9d8672","Light brown":"#decab2",Yellow:"#fbbc33","Light yellow":"#ffdc88"},textColours={Black:"#000000",White:"#ffffff",Grey:"#808080"},fontSizes={"36px":36,"48px":48,"60px":60,"72px":72},instagramRatio=1.35,urlFontSize=24,lineHeightRatio=1.3,creditFontSize=18;angular.module("cardkitApp").controller("MainCtrl",["$scope","$filter","saveSvgAsPng","themeConfig",function(a,b,c,d){function e(){a.defaultConfig=angular.copy(a.config),a.$broadcast("resetSvg")}function f(b,c){var d=new FileReader;d.onload=function(){a.config.svg.elements[c].src=d.result,a.$apply()},d.readAsDataURL(b)}function g(a){return a.stopPropagation(),a.preventDefault(),a.dataTransfer||null}function h(a){return a.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}function i(){var c=[];angular.forEach(a.config.svg.elements,function(a){c.push(a)});var d=b("filter")(c,{useAsFilename:!0,type:"text"},!0)[0],e="image.png";return d&&d.text.length>0&&(e=h(d.text)+".png"),e}if(a.config={sizes:[{name:"Twitter 800 x 400",width:800,height:400,marginTop:20,marginSide:60,small:!0,"default":!1},{name:"Instgram 1080 x 1080",width:1080,height:1080,marginTop:20,marginSide:20,small:!1,"default":!0}],themes:d,output:{scale:1,editable:{scale:!1}},svg:{canvas:{height:function(){return a.size.height},width:function(){return a.size.width},fill:"transparent"},elements:{background:{name:"Background Colour",type:"rect",height:function(){return a.size.height},width:function(){return a.size.width},fill:function(){return a.theme.background},editable:{fill:fillColours}},image:{name:"Image",type:"image",width:1080,height:function(){return this.width},src:"",opacity:1,x:"0%",y:"0%",preserveAspectRatio:"xMinYMin meet",draggable:!0,defaultFilter:"",editable:{src:!0,width:!0,opacity:!0,filters:["Sepia","Grayscale","Saturate","Invert","Blur"]}},logo:{name:"Logo",type:"image",width:function(){return a.size.small?a.theme.logo.width:a.theme.logo.width*instagramRatio},height:function(){return a.size.small?a.theme.logo.height:a.theme.logo.height*instagramRatio},opacity:1,src:function(){return a.theme.logo.src},x:function(){return a.theme.logo.alignedLeft?a.size.marginSide:a.size.width-this.width()-a.size.marginSide},y:function(){return a.theme.logo.alignedTop?a.size.marginTop:a.size.height-this.height()-a.size.marginTop},preserveAspectRatio:"xMinYMin meet",draggable:{x:!1,y:!1},showHoverArea:!1},headline:{name:"Headline",type:"text",text:"Welcome to the Nature\nsocial media image generator,\nplease upload an image and\ncustomise the design.",fill:function(){return a.theme.quote},fontSize:fontSizes["48px"],fontFamily:function(){return a.theme.headline.font},fontWeight:"normal",lineHeight:function(){return this.fontSize*lineHeightRatio},textAnchor:"middle",x:"50%",y:function(){return.26*a.size.height},draggable:!0,showHoverArea:!0,editable:{text:!0,fill:textColours,textAnchor:!0,fontSize:fontSizes},useAsFilename:!0},url:{name:"URL",type:"text",text:"bit.ly/xyxyxy",fill:function(){return a.theme.quote},fontSize:function(){return a.size.small?urlFontSize:urlFontSize*instagramRatio},lineHeight:function(){return this.fontSize()*lineHeightRatio},fontWeight:"normal",fontFamily:function(){return a.theme.url.font},textAnchor:function(){return a.theme.url.alignedLeft?"start":"end"},x:function(){return a.theme.url.alignedLeft?a.size.marginSide:a.size.width-a.size.marginSide},y:function(){return a.size.height-a.size.marginTop},draggable:!0,showHoverArea:!0,editable:{text:!0,fill:textColours,textAnchor:!0}},credit:{name:"credit",type:"text",text:"Image credit",fill:function(){return a.theme.quote},fontSize:function(){return a.size.small?creditFontSize:creditFontSize*instagramRatio},lineHeight:22,fontWeight:"normal",fontFamily:function(){return a.theme.url.font},textAnchor:function(){return a.theme.credit.side?"start":"end"},x:function(){return a.theme.credit.side?0:a.size.width-a.size.marginSide},y:function(){return a.theme.credit.side?0:a.size.height-a.size.marginTop},transform:function(){return a.theme.credit.side?"translate(10, 10) rotate(90)":"transform(0, 0)"},draggable:!1,showHoverArea:!1,editable:{text:!0,fill:textColours}}}}},"undefined"!=typeof a.config.themes){var j=b("filter")(a.config.themes,{"default":!0},!0)[0];j?a.theme=j:a.theme=a.config.themes.length>1?null:a.config.themes[0]}var k=b("filter")(a.config.sizes,{"default":!0},!0)[0];k?a.size=k:a.size=a.config.sizes.length>1?null:a.config.sizes[0],a.$watch("theme",function(){a.$broadcast("changeTheme"),e()}),a.$watch("size",function(){a.$broadcast("changeSize"),e()}),a.resetSvg=function(){a.config.svg=a.defaultConfig.svg,e()},a.onDrop=function(a,b,c){var d=g(b);f(d.files[0],c)},a.fileChanged=function(a){f(angular.element(a)[0].files[0],angular.element(a).data("key"))},a.removeImage=function(b){a.config.svg.elements[b].src=""},a.downloadSvg=function(){var b=i();c(document.getElementById("snap-svg"),b,{scale:a.config.output.scale})}}]),angular.module("cardkitApp").service("snapSVG",["$window",function(a){return a.Snap}]),angular.module("cardkitApp").directive("snapSvg",["snapSVG",function(a){return{template:'<svg id="snap-svg"></svg>',restrict:"E",scope:{svgConfig:"=",svgTheme:"="},link:function(b,c){function d(a){var b={};for(var c in a)switch(typeof a[c]){case"function":b[c]=a[c]();break;default:b[c]=a[c]}return b}function e(a,b){for(var c="",d=document.styleSheets,e=0;e<d.length;e++)if(f(d[e].href))console.warn("Cannot include styles from other hosts: "+d[e].href);else{var g=d[e].cssRules;if(null!==g)for(var h=0;h<g.length;h++){var i=g[h];if("undefined"!=typeof i.style)try{var j=a.querySelectorAll(i.selectorText);if(j.length>0){var k=b?b(i.selectorText):i.selectorText;c+=k+" { "+i.style.cssText+" }\n"}else i.cssText.match(/^@font-face/)&&(c+=i.cssText+"\n")}catch(l){}}}return c}function f(a){return a&&0===a.lastIndexOf("http",0)&&-1===a.lastIndexOf(window.location.host)}function g(){r={Sepia:m.paper.filter(a.filter.sepia(1)).attr({width:4*p.width+"px",height:4*p.height+"px"}),Grayscale:m.paper.filter(a.filter.grayscale(1)).attr({width:4*p.width+"px",height:4*p.height+"px"}),Saturate:m.paper.filter(a.filter.saturate(.5)).attr({width:4*p.width+"px",height:4*p.height+"px"}),Invert:m.paper.filter(a.filter.invert(1)).attr({width:4*p.width+"px",height:4*p.height+"px"}),Blur:m.paper.filter(a.filter.blur(4,4)).attr({width:4*p.width+"px",height:4*p.height+"px"})}}function h(a){var c;if(a.yAttach){if(angular.isObject(a.yAttach))var e=b.svgConfig.elements[a.yAttach.element],f=a.yAttach.offset||0;else var e=b.svgConfig.elements[a.yAttach],f=0;var g,j=e.text.split("\n"),k=e.y;switch(typeof e.lineHeight){case"function":g=e.lineHeight();break;default:g=e.lineHeight}var l=j.length*(g||e.fontSize)+k+f;a.y=l}switch(a=d(a),a.type){case"text":c=m.text(a.x,a.y);break;case"image":c=m.image(a.src,a.x,a.y,a.width,a.height);break;case"rect":c=m.rect(a.x,a.y,a.width,a.height,0,0);break;case"circle":break;case"group":var n;c="",angular.forEach(a.elements,function(a,b){n=h(a),i(n,a),0===b?c=m.group(n):c.group(n)});break;default:return!1}return"undefined"!=typeof a.defaultFilter&&(""!==a.defaultFilter?c.attr({filter:r[a.defaultFilter]}):c.attr({filter:""})),c}function i(a,b){var c=d(b),e=c;return delete e.$$hashKey,"text"===e.type&&(e.text=e.text.split("\n")),angular.isObject(e.draggable)&&(e.draggablex=e.draggable.x,e.draggabley=e.draggable.y),a.attr(e),"text"===e.type&&a.selectAll("tspan").forEach(function(a,b){a.attr({x:e.x,y:e.y+(e.lineHeight||e.fontSize)*b})}),a}function j(){var a=d(b.svgConfig.canvas);m.attr({viewBox:"0, 0, "+a.width+", "+a.height,"data-width":a.width,"data-height":a.height}),i(q,b.svgConfig.canvas);var c;angular.forEach(b.svgConfig.elements,function(a,d){if("undefined"!=typeof t[d]){s=t[d],c=s.matrix;var e=h(b.svgConfig.elements[d]);if(e===!1)return;if(s.after(e),e.transform(c),s.remove(),s=e,t[d]=s,"g"===s.type){if(c=s.matrix,s.remove(),s=h(b.svgConfig.elements[d]),s===!1)return;s.transform(c),t[d]=s}}else{if(s=h(a),s===!1)return;t[d]=s}a.draggable&&s.hover(function(b){if(!m.elementDragging&&a.showHoverArea){var c=this.getBBox();this.hoverRect=m.rect(c.x,c.y,c.width,c.height,0,0).attr({fill:"rgba(0, 0, 0, 0.05)"}),this.before(this.hoverRect)}m.elementDragging&&a.showHoverArea&&(this.unhoveringDuringDragging=!1)},function(b){!m.elementDragging&&a.showHoverArea&&this.hoverRect&&this.hoverRect.remove(),m.elementDragging&&a.showHoverArea&&this.hoverRect&&(this.unhoveringDuringDragging=!0)});var f=a;delete f.$$hashKey,i(s,a),a.draggable&&(s.undrag(),angular.isObject(a.draggable)?s.altDrag(a.draggable.x,a.draggable.y):s.altDrag(!0,!0))})}function k(){m.selectAll("*")}var l=angular.fromJson(b.svgConfig);a.plugin(function(a,b){b.prototype.altDrag=function(a,b){return a&&b?this.drag(d,c,g):a&&!b?this.drag(e,c,g):!a&&b&&this.drag(f,c,g),this};var c=function(){this.data("ot",this.transform().local),m.elementDragging=!0},d=function(a,b){var c,d,e=this.transform().diffMatrix.invert();e.e=e.f=0,c=e.x(a,b),d=e.y(a,b),this.transform(this.data("ot")+"t"+[c,d]),this.hoverRect&&this.hoverRect.transform("t"+[0,0]+"t"+[c,d])},e=function(a,b){var c,d,e=this.transform().diffMatrix.invert();e.e=e.f=0,c=e.x(a,b),d=e.y(a,b),this.transform(this.data("ot")+"t"+[c,0]),this.hoverRect&&this.hoverRect.transform("t"+[0,0]+"t"+[c,0])},f=function(a,b){var c,d,e=this.transform().diffMatrix.invert();e.e=e.f=0,c=e.x(a,b),d=e.y(a,b),this.transform(this.data("ot")+"t"+[0,d]),this.hoverRect&&this.hoverRect.transform("t"+[0,0]+"t"+[0,d])},g=function(){if(m.elementDragging=!1,this.hoverRect){var a=this.hoverRect.getBBox();this.hoverRect.remove(),this.hoverRect=m.rect(a.x,a.y,a.width,a.height,0,0).attr({fill:"rgba(0, 0, 0, 0.05)"}),this.before(this.hoverRect)}this.unhoveringDuringDragging&&(this.hoverRect.remove(),this.unhoveringDuringDragging=!1)}});var m=a(c[0].children[0]);m.attr({height:"100%",width:"100%"});var n=m.paper.el("style",{type:"text/css"}),o=e(m.node);n.node.innerHTML=o,n.toDefs();var p=d(l.canvas),q=m.rect(0,0,p.width,p.height,0,0).attr(p);p.draggable===!0&&q.altDrag(!0,!0);var r;g();var s,t={};b.$watch("svgConfig",j,!0),b.$on("changeTheme",j),b.$on("changeSize",j),b.$on("changeSize",g),b.$on("resetSvg",k)}}}]),angular.module("cardkitApp").service("saveSvgAsPng",["$window",function(a){return a.saveSvgAsPng}]),angular.module("cardkitApp").directive("fixedScroll",["$window",function(a){return function(b,c){var d=c.offset().top-20;angular.element(a).bind("scroll",function(){angular.element(a).scrollTop()>=d?c.addClass("fixed"):c.removeClass("fixed")})}}]),angular.module("cardkitApp").provider("themeConfigProvider",function(){return{$get:["$http","$q",function(a,b){var c=a.get("themes.config.json")["catch"](function(a){return 404===a.status?[]:b.reject(a)});return b.all([c]).then(function(a){return a[0].data})}]}}),angular.module("cardkitApp").directive("textEditor",function(){return{template:'<div><label>Text</label><textarea ng-model="element.text" class="form-control"></textarea></div>',restrict:"E",replace:!0,scope:{element:"="}}}),angular.module("cardkitApp").directive("fillEditor",function(){return{template:'<div><label>Colour</label><select ng-model="element.fill" ng-options="name for (name, value) in field" class="form-control"><option value="">-- Select a colour --</option></select></div>',restrict:"E",scope:{field:"=",element:"="}}}),angular.module("cardkitApp").directive("fontsizeEditor",function(){return{template:'<div><label>Font Size</label><select ng-model="element.fontSize" ng-options="name for (name, value) in field" class="form-control"><option value="">-- Select a Font Size --</option></select></div>',restrict:"E",replace:!0,scope:{element:"=",field:"="}}}),angular.module("cardkitApp").directive("fontfamilyEditor",function(){return{template:'<div><label>Font Family</label><select ng-model="element.fontFamily" ng-options="name for (name, value) in field" class="form-control"><option value="">-- Select a Font Family --</option></select></div>',restrict:"E",replace:!0,scope:{element:"=",field:"="}}}),angular.module("cardkitApp").directive("imageEditor",function(){return{template:'<div><label>Image</label><div ng-if="field === true" class="dropzone" drop="onDrop($data, $event, key)" drop-effect="copy" drop-accept="\'Files\'" drag-over-class="drag-over-accept"><div class="fileInputWrapper button"><span>or select an image</span><input onchange="angular.element(this).scope().fileChanged(this, event)" data-key="{{key}}" type="file" accept="image/*" /></div></div><select ng-model="element.src" ng-options="name for (name, value) in field" class="form-control" ng-if="field !== true && field !== false"><option value="">-- Select an image --</option></select><button ng-show="config.elements[key].src !== \'\'" ng-click="removeImage(key)" class="button button-danger"><i class="fa fa-times"></i> Remove Image</button></div>',restrict:"E",scope:{key:"=",onDrop:"=",removeImage:"=",fileChanged:"=fileChanged",field:"=",element:"="},link:function(a,b){(""===a.element.src||"undefined"==typeof a.element.src)&&angular.isObject(a.field)&&(a.element.src=a.field[Object.keys(a.field)[0]])}}}),angular.module("cardkitApp").directive("sizeEditor",function(){return{template:'<div><label>Size</label><input type="range" min="10" max="1800" ng-model="element.width" /></div>',restrict:"E",replace:!0,scope:{element:"="}}}),angular.module("cardkitApp").directive("textanchorEditor",function(){return{template:'<div><label>Align Text</label><select ng-model="element.textAnchor" class="form-control"><option value="start">Left</option><option value="middle">Centre</option><option value="end">Right</option></select></div>',restrict:"E",replace:!0,scope:{element:"="}}}),angular.module("cardkitApp").directive("opacityEditor",function(){return{template:'<div><label>Opacity</label><input type="range" min="0" max="1" ng-model="element.opacity" step="0.05" /></div>',restrict:"E",replace:!0,scope:{element:"=element"}}}),angular.module("cardkitApp").directive("filterEditor",function(){return{template:'<div><label>Filter</label><select ng-model="element.defaultFilter" ng-options="filter for filter in filters" class="form-control"><option value="">No filter</option></select></div>',replace:!0,restrict:"E",scope:{element:"=",filters:"="}}});